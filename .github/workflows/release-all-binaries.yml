name: Release All Binaries

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: 'false'
        type: boolean
      build_static:
        description: 'Build static binaries (Linux only)'
        required: false
        default: 'true'
        type: boolean

env:
  CRYSTAL_VERSION: '1.14.0'

# Define all binaries to build
# This list matches shard.yml targets
jobs:
  # Build matrix for all binaries on Linux x86_64
  build-linux-x64:
    name: Build Linux x86_64 Binaries
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Crystal
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/crystal
          lib
        key: crystal-release-${{ env.CRYSTAL_VERSION }}-${{ hashFiles('shard.yml') }}

    - name: Install Crystal
      uses: crystal-lang/install-crystal@v1
      with:
        crystal: ${{ env.CRYSTAL_VERSION }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsqlite3-dev \
          libevent-dev \
          libssl-dev \
          libgmp-dev \
          libyaml-dev \
          libpcre2-dev \
          musl-tools \
          musl-dev

    - name: Install dependencies
      run: shards install --production

    - name: Build all binaries
      run: |
        mkdir -p dist/linux-x64

        BUILD_FLAGS="--release --no-debug"
        if [ "${{ github.event.inputs.build_static }}" = "true" ]; then
          BUILD_FLAGS="$BUILD_FLAGS --static"
        fi

        echo "Building with flags: $BUILD_FLAGS"

        # Define all targets
        declare -A TARGETS=(
          # Main application
          ["crystalcog"]="src/crystalcog.cr"

          # Core libraries
          ["cogutil"]="src/cogutil/cogutil.cr"
          ["atomspace"]="src/atomspace/atomspace.cr"
          ["atomspace_main"]="src/atomspace/atomspace_main.cr"
          ["opencog"]="src/opencog/opencog.cr"

          # Reasoning engines
          ["pln"]="src/pln/pln.cr"
          ["ure"]="src/ure/ure.cr"

          # Specialized components
          ["moses"]="src/moses/moses.cr"
          ["moses_main"]="src/moses/moses_main.cr"
          ["attention"]="src/attention/attention.cr"
          ["attention_main"]="src/attention/attention_main.cr"
          ["learning"]="src/learning/learning_main.cr"
          ["ml"]="src/ml/ml_main.cr"
          ["ai_bridge"]="src/ai_integration/ai_bridge.cr"

          # Pattern processing
          ["pattern_matching"]="src/pattern_matching/pattern_matching_main.cr"
          ["pattern_mining"]="src/pattern_mining/pattern_mining_main.cr"

          # NLP
          ["nlp"]="src/nlp/nlp_main.cr"

          # Server applications
          ["cogserver"]="src/cogserver/cogserver_main.cr"

          # Agent-Zero
          ["distributed_network_demo"]="src/agent-zero/distributed_network_demo.cr"
          ["agent_zero"]="src/agent-zero/agent_zero_main.cr"

          # Phase 6-7 components
          ["spatial"]="src/spatial/spatial.cr"
          ["temporal"]="src/temporal/temporal.cr"
          ["behavior"]="src/behavior/behavior.cr"
        )

        SUCCESS=0
        FAILED=0

        for target in "${!TARGETS[@]}"; do
          source="${TARGETS[$target]}"
          output="dist/linux-x64/$target"

          echo ""
          echo "Building $target from $source..."

          if [ -f "$source" ]; then
            if crystal build $BUILD_FLAGS "$source" -o "$output" 2>&1; then
              echo "  ✓ $target built successfully"
              ((SUCCESS++))
            else
              echo "  ✗ $target build failed"
              ((FAILED++))
            fi
          else
            echo "  ⚠ Source file $source not found, skipping"
          fi
        done

        echo ""
        echo "=== Build Summary ==="
        echo "Successful builds: $SUCCESS"
        echo "Failed builds: $FAILED"
        echo ""
        echo "Built binaries:"
        ls -lh dist/linux-x64/

    - name: Create tarball
      run: |
        cd dist
        tar -czvf crystalcog-linux-x86_64.tar.gz linux-x64/
        sha256sum crystalcog-linux-x86_64.tar.gz > crystalcog-linux-x86_64.tar.gz.sha256

    - name: Upload Linux x64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: crystalcog-linux-x86_64
        path: |
          dist/crystalcog-linux-x86_64.tar.gz
          dist/crystalcog-linux-x86_64.tar.gz.sha256
        retention-days: 30

  # Build for Linux ARM64
  build-linux-arm64:
    name: Build Linux ARM64 Binaries
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Build ARM64 binaries in Docker
      run: |
        mkdir -p dist/linux-arm64

        docker run --rm --platform linux/arm64 \
          -v $(pwd):/workspace \
          -w /workspace \
          crystallang/crystal:1.14.0-alpine \
          sh -c '
            apk add --no-cache sqlite-dev libevent-dev openssl-dev yaml-dev pcre2-dev gmp-dev

            shards install --production

            mkdir -p dist/linux-arm64

            # Build main binaries
            for target in crystalcog cogserver nlp pattern_matching moses; do
              case $target in
                crystalcog)
                  src="src/crystalcog.cr"
                  ;;
                cogserver)
                  src="src/cogserver/cogserver_main.cr"
                  ;;
                nlp)
                  src="src/nlp/nlp_main.cr"
                  ;;
                pattern_matching)
                  src="src/pattern_matching/pattern_matching_main.cr"
                  ;;
                moses)
                  src="src/moses/moses_main.cr"
                  ;;
              esac

              if [ -f "$src" ]; then
                echo "Building $target..."
                crystal build --release --no-debug "$src" -o "dist/linux-arm64/$target" || echo "Failed: $target"
              fi
            done

            ls -lh dist/linux-arm64/
          '

    - name: Create ARM64 tarball
      run: |
        cd dist
        tar -czvf crystalcog-linux-arm64.tar.gz linux-arm64/
        sha256sum crystalcog-linux-arm64.tar.gz > crystalcog-linux-arm64.tar.gz.sha256

    - name: Upload Linux ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: crystalcog-linux-arm64
        path: |
          dist/crystalcog-linux-arm64.tar.gz
          dist/crystalcog-linux-arm64.tar.gz.sha256
        retention-days: 30

  # Build for macOS x86_64
  build-macos-x64:
    name: Build macOS x86_64 Binaries
    runs-on: macos-13  # Intel Mac
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Crystal
      uses: crystal-lang/install-crystal@v1
      with:
        crystal: ${{ env.CRYSTAL_VERSION }}

    - name: Install system dependencies
      run: |
        brew install sqlite3 libevent openssl gmp libyaml pcre2

    - name: Install dependencies
      run: shards install --production

    - name: Build all binaries
      run: |
        mkdir -p dist/macos-x64

        BUILD_FLAGS="--release --no-debug"

        declare -A TARGETS=(
          ["crystalcog"]="src/crystalcog.cr"
          ["cogutil"]="src/cogutil/cogutil.cr"
          ["atomspace"]="src/atomspace/atomspace.cr"
          ["atomspace_main"]="src/atomspace/atomspace_main.cr"
          ["opencog"]="src/opencog/opencog.cr"
          ["pln"]="src/pln/pln.cr"
          ["ure"]="src/ure/ure.cr"
          ["moses"]="src/moses/moses.cr"
          ["moses_main"]="src/moses/moses_main.cr"
          ["attention"]="src/attention/attention.cr"
          ["attention_main"]="src/attention/attention_main.cr"
          ["learning"]="src/learning/learning_main.cr"
          ["ml"]="src/ml/ml_main.cr"
          ["ai_bridge"]="src/ai_integration/ai_bridge.cr"
          ["pattern_matching"]="src/pattern_matching/pattern_matching_main.cr"
          ["pattern_mining"]="src/pattern_mining/pattern_mining_main.cr"
          ["nlp"]="src/nlp/nlp_main.cr"
          ["cogserver"]="src/cogserver/cogserver_main.cr"
          ["distributed_network_demo"]="src/agent-zero/distributed_network_demo.cr"
          ["agent_zero"]="src/agent-zero/agent_zero_main.cr"
          ["spatial"]="src/spatial/spatial.cr"
          ["temporal"]="src/temporal/temporal.cr"
          ["behavior"]="src/behavior/behavior.cr"
        )

        for target in "${!TARGETS[@]}"; do
          source="${TARGETS[$target]}"
          if [ -f "$source" ]; then
            echo "Building $target..."
            crystal build $BUILD_FLAGS "$source" -o "dist/macos-x64/$target" 2>&1 || echo "Failed: $target"
          fi
        done

        ls -lh dist/macos-x64/

    - name: Create tarball
      run: |
        cd dist
        tar -czvf crystalcog-macos-x86_64.tar.gz macos-x64/
        shasum -a 256 crystalcog-macos-x86_64.tar.gz > crystalcog-macos-x86_64.tar.gz.sha256

    - name: Upload macOS x64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: crystalcog-macos-x86_64
        path: |
          dist/crystalcog-macos-x86_64.tar.gz
          dist/crystalcog-macos-x86_64.tar.gz.sha256
        retention-days: 30

  # Build for macOS ARM64 (Apple Silicon)
  build-macos-arm64:
    name: Build macOS ARM64 Binaries
    runs-on: macos-14  # Apple Silicon
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Crystal
      uses: crystal-lang/install-crystal@v1
      with:
        crystal: ${{ env.CRYSTAL_VERSION }}

    - name: Install system dependencies
      run: |
        brew install sqlite3 libevent openssl gmp libyaml pcre2

    - name: Install dependencies
      run: shards install --production

    - name: Build all binaries
      run: |
        mkdir -p dist/macos-arm64

        BUILD_FLAGS="--release --no-debug"

        declare -A TARGETS=(
          ["crystalcog"]="src/crystalcog.cr"
          ["cogutil"]="src/cogutil/cogutil.cr"
          ["atomspace"]="src/atomspace/atomspace.cr"
          ["atomspace_main"]="src/atomspace/atomspace_main.cr"
          ["opencog"]="src/opencog/opencog.cr"
          ["pln"]="src/pln/pln.cr"
          ["ure"]="src/ure/ure.cr"
          ["moses"]="src/moses/moses.cr"
          ["moses_main"]="src/moses/moses_main.cr"
          ["attention"]="src/attention/attention.cr"
          ["attention_main"]="src/attention/attention_main.cr"
          ["learning"]="src/learning/learning_main.cr"
          ["ml"]="src/ml/ml_main.cr"
          ["ai_bridge"]="src/ai_integration/ai_bridge.cr"
          ["pattern_matching"]="src/pattern_matching/pattern_matching_main.cr"
          ["pattern_mining"]="src/pattern_mining/pattern_mining_main.cr"
          ["nlp"]="src/nlp/nlp_main.cr"
          ["cogserver"]="src/cogserver/cogserver_main.cr"
          ["distributed_network_demo"]="src/agent-zero/distributed_network_demo.cr"
          ["agent_zero"]="src/agent-zero/agent_zero_main.cr"
          ["spatial"]="src/spatial/spatial.cr"
          ["temporal"]="src/temporal/temporal.cr"
          ["behavior"]="src/behavior/behavior.cr"
        )

        for target in "${!TARGETS[@]}"; do
          source="${TARGETS[$target]}"
          if [ -f "$source" ]; then
            echo "Building $target..."
            crystal build $BUILD_FLAGS "$source" -o "dist/macos-arm64/$target" 2>&1 || echo "Failed: $target"
          fi
        done

        ls -lh dist/macos-arm64/

    - name: Create tarball
      run: |
        cd dist
        tar -czvf crystalcog-macos-arm64.tar.gz macos-arm64/
        shasum -a 256 crystalcog-macos-arm64.tar.gz > crystalcog-macos-arm64.tar.gz.sha256

    - name: Upload macOS ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: crystalcog-macos-arm64
        path: |
          dist/crystalcog-macos-arm64.tar.gz
          dist/crystalcog-macos-arm64.tar.gz.sha256
        retention-days: 30

  # Create Docker images
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-linux-x64]
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Linux x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: crystalcog-linux-x86_64
        path: dist/

    - name: Extract binaries for Docker
      run: |
        cd dist
        tar -xzvf crystalcog-linux-x86_64.tar.gz

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Create production Dockerfile
      run: |
        cat > Dockerfile.release << 'EOF'
        FROM alpine:3.19

        RUN apk add --no-cache \
            sqlite-libs \
            libevent \
            openssl \
            libgcc \
            libstdc++ \
            gmp \
            yaml \
            pcre2 \
            && adduser -D -u 1000 crystalcog

        WORKDIR /app

        # Copy all binaries
        COPY dist/linux-x64/ /app/bin/

        # Make all binaries executable
        RUN chmod +x /app/bin/*

        # Add to PATH
        ENV PATH="/app/bin:$PATH"

        USER crystalcog

        EXPOSE 18080

        ENTRYPOINT ["crystalcog"]
        EOF

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.release
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }}
          ghcr.io/${{ github.repository }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create CogServer Docker image
      run: |
        cat > Dockerfile.cogserver << 'EOF'
        FROM alpine:3.19

        RUN apk add --no-cache \
            sqlite-libs \
            libevent \
            openssl \
            libgcc \
            libstdc++ \
            gmp \
            yaml \
            pcre2 \
            && adduser -D -u 1000 cogserver

        WORKDIR /app

        COPY dist/linux-x64/cogserver /app/cogserver

        RUN chmod +x /app/cogserver

        USER cogserver

        EXPOSE 18080

        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
          CMD wget --no-verbose --tries=1 --spider http://localhost:18080/status || exit 1

        ENTRYPOINT ["/app/cogserver"]
        EOF

    - name: Build and push CogServer image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.cogserver
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/cogserver:${{ steps.get_version.outputs.version }}
          ghcr.io/${{ github.repository }}/cogserver:latest

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux-x64, build-linux-arm64, build-macos-x64, build-macos-arm64, build-docker]
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts/

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: List artifacts
      run: |
        echo "Downloaded artifacts:"
        find release-artifacts/ -type f

    - name: Generate release notes
      run: |
        cat > RELEASE_NOTES.md << EOF
        # CrystalCog ${{ steps.get_version.outputs.version }}

        A complete Crystal implementation of the OpenCog AI framework.

        ## What's Included

        This release includes **23 binaries** built for multiple platforms:

        ### Core Components
        - **crystalcog** - Main application
        - **cogserver** - REST API server with WebSocket support
        - **atomspace** - Hypergraph knowledge store
        - **opencog** - Reasoning interface

        ### Reasoning Engines
        - **pln** - Probabilistic Logic Networks
        - **ure** - Unified Rule Engine
        - **moses** - Meta-Optimizing Semantic Evolutionary Search
        - **pattern_matching** - Pattern matching engine
        - **pattern_mining** - Pattern discovery

        ### AI Components
        - **attention** - ECAN attention allocation
        - **nlp** - Natural language processing
        - **ml** - Machine learning integration
        - **learning** - Concept learning
        - **ai_bridge** - External AI system bridges

        ### Distributed Systems
        - **agent_zero** - Agent-Zero main
        - **distributed_network_demo** - Distributed network demonstration

        ### Phase 6-7 Components
        - **spatial** - Spatial reasoning
        - **temporal** - Temporal reasoning
        - **behavior** - Goal-oriented behavior planning

        ## Platform Support

        | Platform | Architecture | Download |
        |----------|-------------|----------|
        | Linux | x86_64 | \`crystalcog-linux-x86_64.tar.gz\` |
        | Linux | ARM64 | \`crystalcog-linux-arm64.tar.gz\` |
        | macOS | x86_64 | \`crystalcog-macos-x86_64.tar.gz\` |
        | macOS | ARM64 (Apple Silicon) | \`crystalcog-macos-arm64.tar.gz\` |

        ## Docker Images

        \`\`\`bash
        # Full CrystalCog
        docker pull ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }}

        # CogServer only
        docker pull ghcr.io/${{ github.repository }}/cogserver:${{ steps.get_version.outputs.version }}
        \`\`\`

        ## Quick Start

        \`\`\`bash
        # Download and extract
        tar -xzf crystalcog-linux-x86_64.tar.gz
        cd linux-x64

        # Run CogServer
        ./cogserver

        # In another terminal, test the API
        curl http://localhost:18080/status
        \`\`\`

        ## Verification

        SHA256 checksums are provided for each archive. Verify with:

        \`\`\`bash
        sha256sum -c crystalcog-linux-x86_64.tar.gz.sha256
        \`\`\`

        ## Documentation

        - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
        - [Examples](https://github.com/${{ github.repository }}/tree/main/examples)
        - [API Documentation](https://github.com/${{ github.repository }}/tree/main/docs)

        EOF

    - name: Prepare release files
      run: |
        mkdir -p release-files
        find release-artifacts/ -name "*.tar.gz" -exec cp {} release-files/ \;
        find release-artifacts/ -name "*.sha256" -exec cp {} release-files/ \;
        ls -lh release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: CrystalCog ${{ steps.get_version.outputs.version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          release-files/*

  # Post-release verification
  verify-release:
    name: Verify Release
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Verify Docker images
      run: |
        echo "Verifying Docker images..."

        # Get version
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi

        # Pull and test images
        docker pull ghcr.io/${{ github.repository }}:$VERSION
        docker run --rm ghcr.io/${{ github.repository }}:$VERSION --version || echo "Version check completed"

        docker pull ghcr.io/${{ github.repository }}/cogserver:$VERSION
        echo "Docker images verified"

    - name: Create release summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Platforms" >> $GITHUB_STEP_SUMMARY
        echo "- Linux x86_64: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Linux ARM64: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- macOS x86_64: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- macOS ARM64: ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "- crystalcog: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- cogserver: ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Binaries Included" >> $GITHUB_STEP_SUMMARY
        echo "23 binaries across all platforms" >> $GITHUB_STEP_SUMMARY
